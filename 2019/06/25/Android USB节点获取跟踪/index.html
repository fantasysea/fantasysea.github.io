<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="公司项目中要经常用到usb输入，比如外接键盘，摄像头。我们平时一般都是通过UsbManager来获取节点然后进行数据的读取。UsbManager是怎么获取节点信息的呢?我们能否不通过UsbManager来读写数据呢？我们来一步步跟踪一下系统源码。 跟踪usb源码调用流程先说结论：最终的实现在usbhost.c这个方法里面  UsbManager调用getDeviceList  关键方法 12345">
<meta name="keywords" content="linux,Android,usb">
<meta property="og:type" content="article">
<meta property="og:title" content="Android USB节点获取跟踪">
<meta property="og:url" content="http://yoursite.com/2019/06/25/Android USB节点获取跟踪/index.html">
<meta property="og:site_name" content="Steve&#39;s Blog">
<meta property="og:description" content="公司项目中要经常用到usb输入，比如外接键盘，摄像头。我们平时一般都是通过UsbManager来获取节点然后进行数据的读取。UsbManager是怎么获取节点信息的呢?我们能否不通过UsbManager来读写数据呢？我们来一步步跟踪一下系统源码。 跟踪usb源码调用流程先说结论：最终的实现在usbhost.c这个方法里面  UsbManager调用getDeviceList  关键方法 12345">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-06-26T04:44:31.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android USB节点获取跟踪">
<meta name="twitter:description" content="公司项目中要经常用到usb输入，比如外接键盘，摄像头。我们平时一般都是通过UsbManager来获取节点然后进行数据的读取。UsbManager是怎么获取节点信息的呢?我们能否不通过UsbManager来读写数据呢？我们来一步步跟踪一下系统源码。 跟踪usb源码调用流程先说结论：最终的实现在usbhost.c这个方法里面  UsbManager调用getDeviceList  关键方法 12345">





  
  
  <link rel="canonical" href="http://yoursite.com/2019/06/25/Android USB节点获取跟踪/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Android USB节点获取跟踪 | Steve's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Steve's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">stay foolish,stay hungery</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/25/Android USB节点获取跟踪/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Steve">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Steve's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android USB节点获取跟踪

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-25 13:06:28" itemprop="dateCreated datePublished" datetime="2019-06-25T13:06:28+08:00">2019-06-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-06-26 12:44:31" itemprop="dateModified" datetime="2019-06-26T12:44:31+08:00">2019-06-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术总结/" itemprop="url" rel="index"><span itemprop="name">技术总结</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>公司项目中要经常用到usb输入，比如外接键盘，摄像头。我们平时一般都是通过UsbManager来获取节点然后进行数据的读取。UsbManager是怎么获取节点信息的呢?我们能否不通过UsbManager来读写数据呢？我们来一步步跟踪一下系统源码。</p>
<h2 id="跟踪usb源码调用流程"><a href="#跟踪usb源码调用流程" class="headerlink" title="跟踪usb源码调用流程"></a>跟踪usb源码调用流程</h2><p>先说结论：最终的实现在usbhost.c这个方法里面</p>
<blockquote>
<p><a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/hardware/usb/UsbManager.java" target="_blank" rel="noopener">UsbManager</a>调用getDeviceList</p>
</blockquote>
<p>关键方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private final IUsbManager mService;</span><br><span class="line"></span><br><span class="line">310    /**</span><br><span class="line">311     * Returns a HashMap containing all USB devices currently attached.</span><br><span class="line">312     * USB device name is the key for the returned HashMap.</span><br><span class="line">313     * The result will be empty if no devices are attached, or if</span><br><span class="line">314     * USB host mode is inactive or unsupported.</span><br><span class="line">315     *</span><br><span class="line">316     * @return HashMap containing all connected USB devices.</span><br><span class="line">317     */</span><br><span class="line">318    public HashMap&lt;String,UsbDevice&gt; getDeviceList() &#123;</span><br><span class="line">319        HashMap&lt;String,UsbDevice&gt; result = new HashMap&lt;String,UsbDevice&gt;();</span><br><span class="line">320        if (mService == null) &#123;</span><br><span class="line">321            return result;</span><br><span class="line">322        &#125;</span><br><span class="line">323        Bundle bundle = new Bundle();</span><br><span class="line">324        try &#123;</span><br><span class="line">325            mService.getDeviceList(bundle);</span><br><span class="line">326            for (String name : bundle.keySet()) &#123;</span><br><span class="line">327                result.put(name, (UsbDevice)bundle.get(name));</span><br><span class="line">328            &#125;</span><br><span class="line">329            return result;</span><br><span class="line">330        &#125; catch (RemoteException e) &#123;</span><br><span class="line">331            throw e.rethrowFromSystemServer();</span><br><span class="line">332        &#125;</span><br><span class="line">333    &#125;</span><br></pre></td></tr></table></figure>

<p>我们看到其实他是调用了<a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/hardware/usb/IUsbManager.aidl" target="_blank" rel="noopener">IUsbManager.aidl</a>（/frameworks/base/core/java/android/hardware/usb/IUsbManager.aidl）的getDeviceList方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">28/** @hide */</span><br><span class="line">29interface IUsbManager</span><br><span class="line">30&#123;</span><br><span class="line">31    /* Returns a list of all currently attached USB devices */</span><br><span class="line">32    void getDeviceList(out Bundle devices);</span><br></pre></td></tr></table></figure>

<p>IUsbManager.aidl的getDeviceList方法和openDevice方法都定义的是aidl，那么必须要找到他的实现类。经查找，找到了<a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/services/usb/java/com/android/server/usb/UsbService.java" target="_blank" rel="noopener">UsbService</a>（/frameworks/base/services/usb/java/com/android/server/usb/UsbService.java）类实现了getDeviceList方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private UsbHostManager mHostManager;</span><br><span class="line"></span><br><span class="line">   /* Returns a list of all currently attached USB devices (host mdoe) */</span><br><span class="line">   @Override</span><br><span class="line">   public void getDeviceList(Bundle devices) &#123;</span><br><span class="line">       if (mHostManager != null) &#123;</span><br><span class="line">           mHostManager.getDeviceList(devices);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>实际是调用了UsbHostManager的getDeviceList方法</p>
<p><a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/services/usb/java/com/android/server/usb/UsbHostManager.java" target="_blank" rel="noopener">UsbHostManager</a>的getDeviceList方法其实是直接拿到了mDevices来填充device。mDevices的key经过后来分析，其实就是devices的name，比如：/dev/bus/usb/001</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">53    // contains all connected USB devices</span><br><span class="line">54    private final HashMap&lt;String, UsbDevice&gt; mDevices = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">316    /* Returns a list of all currently attached USB devices */</span><br><span class="line">317    public void getDeviceList(Bundle devices) &#123;</span><br><span class="line">318        synchronized (mLock) &#123;</span><br><span class="line">319            for (String name : mDevices.keySet()) &#123;</span><br><span class="line">320                devices.putParcelable(name, mDevices.get(name));</span><br><span class="line">321            &#125;</span><br><span class="line">322        &#125;</span><br><span class="line">323    &#125;</span><br></pre></td></tr></table></figure>

<p>mDevices对象就是所有的devices，我们继续看一下 mDevices怎么来的。UsbHostManager.java方法中有beginUsbDeviceAdded和endUsbDeviceAdded方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">    /* Called from JNI in monitorUsbHostBus() to finish adding a new device */</span><br><span class="line">238    @SuppressWarnings(&quot;unused&quot;)</span><br><span class="line">239    private void endUsbDeviceAdded() &#123;</span><br><span class="line">240        if (DEBUG) &#123;</span><br><span class="line">241            Slog.d(TAG, &quot;usb:UsbHostManager.endUsbDeviceAdded()&quot;);</span><br><span class="line">242        &#125;</span><br><span class="line">243        if (mNewInterface != null) &#123;</span><br><span class="line">244            mNewInterface.setEndpoints(</span><br><span class="line">245                    mNewEndpoints.toArray(new UsbEndpoint[mNewEndpoints.size()]));</span><br><span class="line">246        &#125;</span><br><span class="line">247        if (mNewConfiguration != null) &#123;</span><br><span class="line">248            mNewConfiguration.setInterfaces(</span><br><span class="line">249                    mNewInterfaces.toArray(new UsbInterface[mNewInterfaces.size()]));</span><br><span class="line">250        &#125;</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253        synchronized (mLock) &#123;</span><br><span class="line">254            if (mNewDevice != null) &#123;</span><br><span class="line">255                mNewDevice.setConfigurations(</span><br><span class="line">256                        mNewConfigurations.toArray(</span><br><span class="line">257                                new UsbConfiguration[mNewConfigurations.size()]));</span><br><span class="line">258                mDevices.put(mNewDevice.getDeviceName(), mNewDevice);</span><br><span class="line">259                Slog.d(TAG, &quot;Added device &quot; + mNewDevice);</span><br><span class="line">260</span><br><span class="line">261                // It is fine to call this only for the current user as all broadcasts are sent to</span><br><span class="line">262                // all profiles of the user and the dialogs should only show once.</span><br><span class="line">263                ComponentName usbDeviceConnectionHandler = getUsbDeviceConnectionHandler();</span><br><span class="line">264                if (usbDeviceConnectionHandler == null) &#123;</span><br><span class="line">265                    getCurrentUserSettings().deviceAttached(mNewDevice);</span><br><span class="line">266                &#125; else &#123;</span><br><span class="line">267                    getCurrentUserSettings().deviceAttachedForFixedHandler(mNewDevice,</span><br><span class="line">268                            usbDeviceConnectionHandler);</span><br><span class="line">269                &#125;</span><br><span class="line">270                // deviceName is something like: &quot;/dev/bus/usb/001/001&quot;</span><br><span class="line">271                UsbDescriptorParser parser = new UsbDescriptorParser();</span><br><span class="line">272                boolean isInputHeadset = false;</span><br><span class="line">273                boolean isOutputHeadset = false;</span><br><span class="line">274                if (parser.parseDevice(mNewDevice.getDeviceName())) &#123;</span><br><span class="line">275                    isInputHeadset = parser.isInputHeadset();</span><br><span class="line">276                    isOutputHeadset = parser.isOutputHeadset();</span><br><span class="line">277                    Slog.i(TAG, &quot;---- isHeadset[in: &quot; + isInputHeadset</span><br><span class="line">278                            + &quot; , out: &quot; + isOutputHeadset + &quot;]&quot;);</span><br><span class="line">279                &#125;</span><br><span class="line">280                mUsbAlsaManager.usbDeviceAdded(mNewDevice,</span><br><span class="line">281                        isInputHeadset, isOutputHeadset);</span><br><span class="line">282            &#125; else &#123;</span><br><span class="line">283                Slog.e(TAG, &quot;mNewDevice is null in endUsbDeviceAdded&quot;);</span><br><span class="line">284            &#125;</span><br><span class="line">285            mNewDevice = null;</span><br><span class="line">286            mNewConfigurations = null;</span><br><span class="line">287            mNewInterfaces = null;</span><br><span class="line">288            mNewEndpoints = null;</span><br><span class="line">289            mNewConfiguration = null;</span><br><span class="line">290            mNewInterface = null;</span><br><span class="line">291        &#125;</span><br><span class="line">292    &#125;</span><br></pre></td></tr></table></figure>

<p>这2个方法就是开始和结束添加deive的方法，mNewDevice就是开始生成一个新device，我们看方法的介绍，都提到了monitorUsbHostBus方法。这monitorUsbHostBus这个方法是jni方法，那到底是谁调用的呢？我们继续跟踪一下。UsbHostManager还有一个systemReady方法，看名字估计是系统准备好了就会调用。这个方法调用了monitorUsbHostBus这个jni方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">380</span><br><span class="line">381    private native void monitorUsbHostBus();</span><br><span class="line">382    private native ParcelFileDescriptor nativeOpenDevice(String deviceName);</span><br><span class="line"></span><br><span class="line">307    public void systemReady() &#123;</span><br><span class="line">308        synchronized (mLock) &#123;</span><br><span class="line">309            // Create a thread to call into native code to wait for USB host events.</span><br><span class="line">310            // This thread will call us back on usbDeviceAdded and usbDeviceRemoved.</span><br><span class="line">311            Runnable runnable = this::monitorUsbHostBus;</span><br><span class="line">312            new Thread(null, runnable, &quot;UsbService host thread&quot;).start();</span><br><span class="line">313        &#125;</span><br><span class="line">314    &#125;</span><br></pre></td></tr></table></figure>

<p>经过查找，<a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/services/core/jni/com_android_server_UsbHostManager.cpp" target="_blank" rel="noopener">com_android_server_UsbHostManager.cpp</a>（/frameworks/base/services/core/jni/com_android_server_UsbHostManager.cpp）中实现了monitorUsbHostBus方法。</p>
<p>monitorUsbHostBus方法跟踪</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">196static const JNINativeMethod method_table[] = &#123;</span><br><span class="line">197    &#123; &quot;monitorUsbHostBus&quot;, &quot;()V&quot;, (void*)android_server_UsbHostManager_monitorUsbHostBus &#125;,</span><br><span class="line">198    &#123; &quot;nativeOpenDevice&quot;,  &quot;(Ljava/lang/String;)Landroid/os/ParcelFileDescriptor;&quot;,</span><br><span class="line">199                                  (void*)android_server_UsbHostManager_openDevice &#125;,</span><br><span class="line">200&#125;;</span><br><span class="line"></span><br><span class="line">static void android_server_UsbHostManager_monitorUsbHostBus(JNIEnv* /* env */, jobject thiz)</span><br><span class="line">160&#123;</span><br><span class="line">161    struct usb_host_context* context = usb_host_init();</span><br><span class="line">162    if (!context) &#123;</span><br><span class="line">163        ALOGE(&quot;usb_host_init failed&quot;);</span><br><span class="line">164        return;</span><br><span class="line">165    &#125;</span><br><span class="line">166    // this will never return so it is safe to pass thiz directly</span><br><span class="line">167    usb_host_run(context, usb_device_added, usb_device_removed, NULL, (void *)thiz);</span><br><span class="line">168&#125;</span><br></pre></td></tr></table></figure>

<p>usb_host_run方法中usb_device_added实现如下，看起来是一个回调。那么usb_host_run就是关键了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">static int usb_device_added(const char *devname, void* client_data) &#123;</span><br><span class="line">61    struct usb_descriptor_header* desc;</span><br><span class="line">62    struct usb_descriptor_iter iter;</span><br><span class="line">63</span><br><span class="line">64    struct usb_device *device = usb_device_open(devname);</span><br><span class="line">65    if (!device) &#123;</span><br><span class="line">66        ALOGE(&quot;usb_device_open failed\n&quot;);</span><br><span class="line">67        return 0;</span><br><span class="line">68    &#125;</span><br><span class="line">69</span><br><span class="line">70    JNIEnv* env = AndroidRuntime::getJNIEnv();</span><br><span class="line">71    jobject thiz = (jobject)client_data;</span><br><span class="line">72    const usb_device_descriptor* deviceDesc = usb_device_get_device_descriptor(device);</span><br><span class="line">73</span><br><span class="line">74    char *manufacturer = usb_device_get_manufacturer_name(device,</span><br><span class="line">75            USB_CONTROL_TRANSFER_TIMEOUT_MS);</span><br><span class="line">76    char *product = usb_device_get_product_name(device,</span><br><span class="line">77            USB_CONTROL_TRANSFER_TIMEOUT_MS);</span><br><span class="line">78    int version = usb_device_get_version(device);</span><br><span class="line">79    char *serial = usb_device_get_serial(device,</span><br><span class="line">80            USB_CONTROL_TRANSFER_TIMEOUT_MS);</span><br><span class="line">81</span><br><span class="line">82    jstring deviceName = env-&gt;NewStringUTF(devname);</span><br><span class="line">83    jstring manufacturerName = AndroidRuntime::NewStringLatin1(env, manufacturer);</span><br><span class="line">84    jstring productName = AndroidRuntime::NewStringLatin1(env, product);</span><br><span class="line">85    jstring serialNumber = AndroidRuntime::NewStringLatin1(env, serial);</span><br><span class="line">86</span><br><span class="line">87    jboolean result = env-&gt;CallBooleanMethod(thiz, method_beginUsbDeviceAdded,</span><br><span class="line">88            deviceName, usb_device_get_vendor_id(device), usb_device_get_product_id(device),</span><br><span class="line">89            deviceDesc-&gt;bDeviceClass, deviceDesc-&gt;bDeviceSubClass, deviceDesc-&gt;bDeviceProtocol,</span><br><span class="line">90            manufacturerName, productName, version, serialNumber);</span><br><span class="line">91</span><br><span class="line">92    env-&gt;DeleteLocalRef(serialNumber);</span><br><span class="line">93    env-&gt;DeleteLocalRef(productName);</span><br><span class="line">94    env-&gt;DeleteLocalRef(manufacturerName);</span><br><span class="line">95    env-&gt;DeleteLocalRef(deviceName);</span><br><span class="line">96    free(manufacturer);</span><br><span class="line">97    free(product);</span><br><span class="line">98    free(serial);</span><br><span class="line">99</span><br><span class="line">100    if (!result) goto fail;</span><br><span class="line">101</span><br><span class="line">102    usb_descriptor_iter_init(device, &amp;iter);</span><br><span class="line">103</span><br><span class="line">104    while ((desc = usb_descriptor_iter_next(&amp;iter)) != NULL) &#123;</span><br><span class="line">105        if (desc-&gt;bDescriptorType == USB_DT_CONFIG) &#123;</span><br><span class="line">106            struct usb_config_descriptor *config = (struct usb_config_descriptor *)desc;</span><br><span class="line">107            char *name = usb_device_get_string(device, config-&gt;iConfiguration,</span><br><span class="line">108                    USB_CONTROL_TRANSFER_TIMEOUT_MS);</span><br><span class="line">109            jstring configName = AndroidRuntime::NewStringLatin1(env, name);</span><br><span class="line">110</span><br><span class="line">111            env-&gt;CallVoidMethod(thiz, method_addUsbConfiguration,</span><br><span class="line">112                    config-&gt;bConfigurationValue, configName, config-&gt;bmAttributes,</span><br><span class="line">113                    config-&gt;bMaxPower);</span><br><span class="line">114</span><br><span class="line">115            env-&gt;DeleteLocalRef(configName);</span><br><span class="line">116            free(name);</span><br><span class="line">117        &#125; else if (desc-&gt;bDescriptorType == USB_DT_INTERFACE) &#123;</span><br><span class="line">118            struct usb_interface_descriptor *interface = (struct usb_interface_descriptor *)desc;</span><br><span class="line">119            char *name = usb_device_get_string(device, interface-&gt;iInterface,</span><br><span class="line">120                    USB_CONTROL_TRANSFER_TIMEOUT_MS);</span><br><span class="line">121            jstring interfaceName = AndroidRuntime::NewStringLatin1(env, name);</span><br><span class="line">122</span><br><span class="line">123            env-&gt;CallVoidMethod(thiz, method_addUsbInterface,</span><br><span class="line">124                    interface-&gt;bInterfaceNumber, interfaceName, interface-&gt;bAlternateSetting,</span><br><span class="line">125                    interface-&gt;bInterfaceClass, interface-&gt;bInterfaceSubClass,</span><br><span class="line">126                    interface-&gt;bInterfaceProtocol);</span><br><span class="line">127</span><br><span class="line">128            env-&gt;DeleteLocalRef(interfaceName);</span><br><span class="line">129            free(name);</span><br><span class="line">130        &#125; else if (desc-&gt;bDescriptorType == USB_DT_ENDPOINT) &#123;</span><br><span class="line">131            struct usb_endpoint_descriptor *endpoint = (struct usb_endpoint_descriptor *)desc;</span><br><span class="line">132</span><br><span class="line">133            env-&gt;CallVoidMethod(thiz, method_addUsbEndpoint,</span><br><span class="line">134                    endpoint-&gt;bEndpointAddress, endpoint-&gt;bmAttributes,</span><br><span class="line">135                    __le16_to_cpu(endpoint-&gt;wMaxPacketSize), endpoint-&gt;bInterval);</span><br><span class="line">136        &#125;</span><br><span class="line">137    &#125;</span><br><span class="line">138</span><br><span class="line">139    env-&gt;CallVoidMethod(thiz, method_endUsbDeviceAdded);</span><br><span class="line">140</span><br><span class="line">141fail:</span><br><span class="line">142    usb_device_close(device);</span><br><span class="line">143    checkAndClearExceptionFromCallback(env, __FUNCTION__);</span><br><span class="line">144</span><br><span class="line">145    return 0;</span><br><span class="line">146&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟踪usb_host_run方法，找到了<a href="http://androidxref.com/8.1.0_r33/xref/system/core/libusbhost/usbhost.c" target="_blank" rel="noopener">usbhost.c</a>(/system/core/libusbhost/usbhost.c)文件.这个文件实现了最终的节点获取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">319 void usb_host_run(struct usb_host_context *context,</span><br><span class="line">310                  usb_device_added_cb added_cb,</span><br><span class="line">311                  usb_device_removed_cb removed_cb,</span><br><span class="line">312                  usb_discovery_done_cb discovery_done_cb,</span><br><span class="line">313                  void *client_data)</span><br><span class="line">314&#123;</span><br><span class="line">315    int done;</span><br><span class="line">316</span><br><span class="line">317    done = usb_host_load(context, added_cb, removed_cb, discovery_done_cb, client_data);</span><br><span class="line">318</span><br><span class="line">319    while (!done) &#123;</span><br><span class="line">320</span><br><span class="line">321        done = usb_host_read_event(context);</span><br><span class="line">322    &#125;</span><br><span class="line">323&#125; /* usb_host_run() */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192int usb_host_load(struct usb_host_context *context,</span><br><span class="line">193                  usb_device_added_cb added_cb,</span><br><span class="line">194                  usb_device_removed_cb removed_cb,</span><br><span class="line">195                  usb_discovery_done_cb discovery_done_cb,</span><br><span class="line">196                  void *client_data)</span><br><span class="line">197&#123;</span><br><span class="line">198    int done = 0;</span><br><span class="line">199    int i;</span><br><span class="line">200</span><br><span class="line">201    context-&gt;cb_added = added_cb;</span><br><span class="line">202    context-&gt;cb_removed = removed_cb;</span><br><span class="line">203    context-&gt;data = client_data;</span><br><span class="line">204</span><br><span class="line">205    D(&quot;Created device discovery thread\n&quot;);</span><br><span class="line">206</span><br><span class="line">207    /* watch for files added and deleted within USB_FS_DIR */</span><br><span class="line">208    context-&gt;wddbus = -1;</span><br><span class="line">209    for (i = 0; i &lt; MAX_USBFS_WD_COUNT; i++)</span><br><span class="line">210        context-&gt;wds[i] = -1;</span><br><span class="line">211</span><br><span class="line">212    /* watch the root for new subdirectories 通过这里观察节点变化*/</span><br><span class="line">213    context-&gt;wdd = inotify_add_watch(context-&gt;fd, DEV_DIR, IN_CREATE | IN_DELETE);</span><br><span class="line">214    if (context-&gt;wdd &lt; 0) &#123;</span><br><span class="line">215        fprintf(stderr, &quot;inotify_add_watch failed\n&quot;);</span><br><span class="line">216        if (discovery_done_cb)</span><br><span class="line">217            discovery_done_cb(client_data);</span><br><span class="line">218        return done;</span><br><span class="line">219    &#125;</span><br><span class="line">220</span><br><span class="line">221    watch_existing_subdirs(context, context-&gt;wds, MAX_USBFS_WD_COUNT);</span><br><span class="line">222</span><br><span class="line">223    /* check for existing devices first, after we have inotify set up */</span><br><span class="line">224    done = find_existing_devices(added_cb, client_data);</span><br><span class="line">225    if (discovery_done_cb)</span><br><span class="line">226        done |= discovery_done_cb(client_data);</span><br><span class="line">227</span><br><span class="line">228    return done;</span><br><span class="line">229&#125; /* usb_host_load() */</span><br><span class="line"></span><br><span class="line">// find_existing_devices 方法先获取已经存在的节点</span><br><span class="line">22/* returns true if one of the callbacks indicates we are done */</span><br><span class="line">123static int find_existing_devices(usb_device_added_cb added_cb,</span><br><span class="line">124                                  void *client_data)</span><br><span class="line">125&#123;</span><br><span class="line">126    char busname[32];</span><br><span class="line">127    DIR *busdir;</span><br><span class="line">128    struct dirent *de;</span><br><span class="line">129    int done = 0;</span><br><span class="line">130</span><br><span class="line">131    busdir = opendir(USB_FS_DIR);</span><br><span class="line">132    if(busdir == 0) return 0;</span><br><span class="line">133</span><br><span class="line">134    while ((de = readdir(busdir)) != 0 &amp;&amp; !done) &#123;</span><br><span class="line">135        if(badname(de-&gt;d_name)) continue;</span><br><span class="line">136</span><br><span class="line">137        snprintf(busname, sizeof(busname), USB_FS_DIR &quot;/%s&quot;, de-&gt;d_name);</span><br><span class="line">138        done = find_existing_devices_bus(busname, added_cb,</span><br><span class="line">139                                         client_data);</span><br><span class="line">140    &#125; //end of busdir while</span><br><span class="line">141    closedir(busdir);</span><br><span class="line">142</span><br><span class="line">143    return done;</span><br><span class="line">144&#125;</span><br></pre></td></tr></table></figure>

<p>终于找到了最终的方法,也就是系统一直在监听DEV_DIR目录的节点变化来向上传递事件。最终通过com_android_server_UsbHostManager.cpp的jni方法（c++调用java）UsbHostManager的beginUsbDeviceAdded和endUsbDeviceAdded方法添加节点到mDevices列数。当UsbManager通过IUsbManager的实现类UsbService来获取列表，UsbService通过UsbHostManager来获取mDevices的数据并通过Bundle返回。</p>
<p>有几个关键path我们值得关注，DEV_DIR是usb节点的默认监控位置。对应linux的/dev 路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">58#define DEV_DIR             &quot;/dev&quot;</span><br><span class="line">59#define DEV_BUS_DIR         DEV_DIR &quot;/bus&quot;</span><br><span class="line">60#define USB_FS_DIR          DEV_BUS_DIR &quot;/usb&quot;</span><br><span class="line">61#define USB_FS_ID_SCANNER   USB_FS_DIR &quot;/%d/%d&quot;</span><br><span class="line">62#define USB_FS_ID_FORMAT    USB_FS_DIR &quot;/%03d/%03d&quot;</span><br><span class="line"></span><br><span class="line">context-&gt;wdd = inotify_add_watch(context-&gt;fd, DEV_DIR, IN_CREATE | IN_DELETE);</span><br></pre></td></tr></table></figure>

<p>总结：这次分析了usb节点的查找和获取方式.如果我们有了读写/dev/bus/usb/001节点的权限，那么完全可以绕过系统的UsbManager来处理usb摄像头等数据，当然就也不需要弹窗授权就可以读取。</p>
<blockquote>
<p>附上一个usb节点的信息，cat /proc/bus/input/devices就可以查看，这些信息和device的信息类似，我们关注的是<br>I: Bus=0003 Vendor=2dbb Product=0300 Version=0100<br>N: Name=”Hjimi,Inc.A200 3DSenor”<br>这2行，Vendor和Product和Name能区分出设备的类型。如果我们app只处理某种摄像头，就可以通过这个判断。</p>
</blockquote>
<h1 id="查看Android输入设置的信息"><a href="#查看Android输入设置的信息" class="headerlink" title="查看Android输入设置的信息"></a>查看Android输入设置的信息</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">/system/bin/sh: cd: /proc/bus/input/devices: Not a directory</span><br><span class="line">2|tb8735ap1_bsp_lr:/dev/input # cat /proc/bus/input/devices</span><br><span class="line">I: Bus=0019 Vendor=2454 Product=6500 Version=0010</span><br><span class="line">N: Name=&quot;mtk-kpd&quot;</span><br><span class="line">P: Phys=</span><br><span class="line">S: Sysfs=/devices/soc/10003000.keypad/input/input0</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=gpufreq_ib event0 keychord</span><br><span class="line">B: PROP=0</span><br><span class="line">B: EV=3</span><br><span class="line">B: KEY=8000 0 40000401 9e37c8 0 0 10004ffc</span><br><span class="line"></span><br><span class="line">I: Bus=0000 Vendor=0000 Product=9110 Version=1060</span><br><span class="line">N: Name=&quot;mtk-tpd&quot;</span><br><span class="line">P: Phys=</span><br><span class="line">S: Sysfs=/devices/virtual/input/input1</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=gpufreq_ib event1</span><br><span class="line">B: PROP=2</span><br><span class="line">B: EV=b</span><br><span class="line">B: KEY=400 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">B: ABS=2630000 1000003</span><br><span class="line"></span><br><span class="line">I: Bus=0003 Vendor=2dbb Product=0203 Version=0100</span><br><span class="line">N: Name=&quot;Hjimi,Inc. A200 HD Video device&quot;</span><br><span class="line">P: Phys=usb-musb-hdrc.0.auto-1.1.1/button</span><br><span class="line">S: Sysfs=/devices/platform/mt_usb/musb-hdrc.0.auto/usb1/1-1/1-1.1/1-1.1.1/1-1.1.1:1.0/input/input88</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=gpufreq_ib event2</span><br><span class="line">B: PROP=0</span><br><span class="line">B: EV=3</span><br><span class="line">B: KEY=100000 0 0 0 0 0 0</span><br><span class="line"></span><br><span class="line">I: Bus=0003 Vendor=2dbb Product=0300 Version=0100</span><br><span class="line">N: Name=&quot;Hjimi,Inc.A200 3DSenor&quot;</span><br><span class="line">P: Phys=usb-musb-hdrc.0.auto-1.1.3/button</span><br><span class="line">S: Sysfs=/devices/platform/mt_usb/musb-hdrc.0.auto/usb1/1-1/1-1.1/1-1.1.3/1-1.1.3:1.0/input/input89</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=gpufreq_ib event3</span><br><span class="line">B: PROP=0</span><br><span class="line">B: EV=3</span><br><span class="line">B: KEY=100000 0 0 0 0 0 0</span><br></pre></td></tr></table></figure>


      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/usb/" rel="tag"># usb</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/21/Linux实用命令总结/" rel="next" title="Linux实用命令总结">
                <i class="fa fa-chevron-left"></i> Linux实用命令总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/04/客显数据抓包分析/" rel="prev" title="客显数据抓包分析">
                客显数据抓包分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Steve</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#跟踪usb源码调用流程"><span class="nav-number">1.</span> <span class="nav-text">跟踪usb源码调用流程</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#查看Android输入设置的信息"><span class="nav-number"></span> <span class="nav-text">查看Android输入设置的信息</span></a></li></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Steve</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.1.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.2"></script>



  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
